# MultiLog 模型使用说明

## 项目概述

MultiLog 是一个用于分布式数据库日志异常检测的多变量深度学习模型。该模型采用两阶段监督学习框架：
- **第一阶段**：独立估计器为每个数据库节点分析日志并生成异常概率
- **第二阶段**：集群分类器综合所有节点的概率进行最终异常判定

## 环境配置

### 1. 系统要求
- Python 3.8+
- CUDA 11.0+ (可选，用于GPU加速)
- 至少 8GB RAM

### 2. 安装依赖

```bash
# 克隆项目
git clone <repository_url>
cd simpleDemo-MultiLog

# 创建虚拟环境（推荐）
python -m venv venv
source venv/bin/activate  # Linux/Mac
# 或
venv\Scripts\activate  # Windows

# 安装依赖
pip install -r requirements.txt
```

### 3. 依赖包说明
- **torch**: 深度学习框架
- **numpy**: 数值计算
- **scikit-learn**: 机器学习工具
- **matplotlib**: 数据可视化
- **seaborn**: 高级可视化
- **drain3**: 日志解析
- **gensim**: 词嵌入（FastText）
- **tqdm**: 进度条显示

## 数据集准备

### Single2Single 数据集
项目使用 Single2Single 数据集，包含11种异常类型：

1. CPU Saturation - CPU资源耗尽
2. IO Saturation - I/O带宽占用
3. Memory Saturation - 内存资源不足
4. Network Bandwidth Limited - 网络带宽受限
5. Network Partition - 网络分区
6. Machine Down - 服务器宕机
7. Accompanying Slow Query - 查询负载过大
8. Export Operations - 数据备份
9. Import Operations - 数据导入
10. Resource-Intensive Compaction - 资源密集型压缩
11. Overly Frequent Disk Flushes - 频繁磁盘刷新

### 数据集结构
```
data/
└── Single2Single/
    ├── cpu_continue/
    │   └── *.log
    ├── io_continue/
    │   └── *.log
    ├── memory_continue/
    │   └── *.log
    └── ...
```

## 模型训练

### 1. 基础训练

使用默认参数训练模型（使用5%数据）：

```bash
python main.py
```

### 2. 自定义参数训练

```bash
python main.py \
    --epochs 20 \
    --batch_size 4 \
    --learning_rate 0.001 \
    --sample_ratio 0.05 \
    --device cuda
```

参数说明：
- `--data_path`: 数据集路径（默认: ./data）
- `--num_nodes`: 节点数量（Single2Single使用1）
- `--epochs`: 训练轮数（默认: 20）
- `--batch_size`: 批次大小（默认: 4）
- `--learning_rate`: 学习率（默认: 0.001）
- `--hidden_size`: LSTM隐藏层大小（默认: 128）
- `--window_size`: 时间窗口大小，秒（默认: 5）
- `--sample_ratio`: 数据采样比例（默认: 0.05，即5%）
- `--device`: 计算设备（cuda/cpu）
- `--save_path`: 模型保存路径（默认: ./checkpoints）

### 3. 带可视化的训练

生成训练过程可视化图表：

```bash
python plt/train_with_visualization.py --epochs 10 --sample_ratio 0.05
```

## 模型评估与可视化

### 1. 生成可视化结果

训练完成后，可视化结果保存在 `plt/figures/` 目录：

- `training_history.png`: 训练损失和准确率曲线
- `confusion_matrix.png`: 混淆矩阵
- `roc_curve.png`: ROC曲线
- `pr_curve.png`: Precision-Recall曲线
- `score_distribution.png`: 异常分数分布

### 2. 单独运行可视化

```bash
python plt/visualize_results.py
```

## 模型架构详解

### 第一阶段：独立估计器
1. **日志解析** (LogParser)
   - 使用 Drain3 算法解析非结构化日志
   - 提取日志模板和参数

2. **特征嵌入** (Embeddings)
   - 序列嵌入：捕获事件序列模式
   - 数量嵌入：统计事件频率
   - 语义嵌入：使用 FastText 提取语义信息

3. **信息增强** (Enhancement)
   - LSTM + Self-Attention 机制
   - 增强三种特征的表达能力

4. **异常概率预测**
   - 输出每个日志组的异常概率

### 第二阶段：集群分类器
1. **概率标准化** (AutoEncoder)
   - 处理不同长度的概率序列
   - 映射到固定维度的隐向量

2. **元分类器** (MetaClassifier)
   - 基于标准化向量进行最终分类
   - 输出：Normal/Anomaly

## 使用示例

### 完整训练流程

```bash
# 1. 准备数据
# 将 Single2Single 数据集放入 data/ 目录

# 2. 训练模型（使用5%数据）
python main.py --epochs 20 --sample_ratio 0.01

# 3. 可视化训练结果
python plt/train_with_visualization.py --epochs 10 --sample_ratio 0.01

# 4. 查看结果
# 训练日志显示在终端
# 模型保存在 checkpoints/best_model.pth
# 可视化图表保存在 plt/figures/
```

### 推理示例

```python
import torch
from MultiLog.multilog import MultiLog

# 加载模型
model = MultiLog(num_nodes=1, hidden_size=128, window_size=5)
checkpoint = torch.load('checkpoints/best_model.pth')
model.load_state_dict(checkpoint['model_state_dict'])
model.eval()

# 准备日志数据
logs = ["2024-01-01 10:00:00 INFO Database connection established",
        "2024-01-01 10:00:01 ERROR Query timeout exceeded",
        ...]

# 预测
with torch.no_grad():
    # 单节点预测
    anomaly_probs = model.standalone_estimators[0](logs)
    is_anomaly = anomaly_probs.mean() > 0.5
```

## 注意事项

1. **内存使用**
   - 使用5%数据训练可显著减少内存占用
   - 批次大小可根据显存调整

2. **训练时间**
   - GPU训练速度约为CPU的5-10倍
   - 5%数据训练一轮约需2-5分钟

3. **数据格式**
   - 日志文件应为文本格式
   - 每行一条日志记录
   - 包含时间戳、日志级别和消息内容

4. **模型保存**
   - 最佳模型自动保存
   - 包含模型权重、优化器状态和训练历史

## 故障排除

### 常见问题

1. **内存不足**
   ```bash
   # 减少批次大小
   python main.py --batch_size 2
   
   # 减少数据量
   python main.py --sample_ratio 0.01
   ```

2. **CUDA错误**
   ```bash
   # 使用CPU训练
   python main.py --device cpu
   ```

3. **依赖包冲突**
   ```bash
   # 重新创建虚拟环境
   rm -rf venv
   python -m venv venv
   source venv/bin/activate
   pip install -r requirements.txt
   ```

## 联系方式

如有问题，请通过以下方式联系：
- 提交 Issue
- 发送邮件至：[your-email]

## 许可证

本项目采用 MIT 许可证。